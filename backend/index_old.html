<html>
	<head>
		<title>Climate Harvest</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<style>
	p{
		padding: 0px;
		margin: 0px;
		font-family:"Courier New", Courier, monospace
		font-size: 10pt;
	}
	#log{
		margin-top: 10%;
	}
	.btn{
		margin-top: 5%;
	}
	#resultsTableHolder{
		text-align: center;
	}
	th {
	    background-color:#333e48;
	    color: white;
	}
	tr:nth-child(even) {background-color: #f2f2f2}
	th, td {
	    padding: 25px;;
	    text-align: left;
	}
	#map{
		height: 50%;
		width: 50%;
	}
	#results{
		margin-top: 5%;
		height 25%;
	}
</style>
	</head>
	<body>
		<h1 class='page-header'>Point Climate Extraction</h1>
		<i>Switch to: </i><a href="neotomaQuery">  Neotoma Query  </a>|<a href='graph'>  GraphView  </a>
		<h6 id='loading'>Loading controls...</h6>
		<div class='container' id='controls1'>
			
			<div class='col-xs-6'>
				<label for='sourceSelect'>Select Data Source: </label><br />
				<select id='sourceSelect' name='sourceSelect'></select><br />

				<label for='varSelect'>Select Climatic Variable: </label><br />
				<select id='varSelect' name='varSelect'></select><br />
			</div>
		</div>
		<div id='controls2' class='container'>
			<div class='col-xs-3'>
				<label for='latitude'>Point Longitude: </label><br />
				<input type='number' value='0.000' step='0.001' name='longitude' id='longitude'/>
				<br />
				<label for='latitude'>Point Latitude: </label><br />
				<input type='number' value='0.000' step='0.001' name='latitude' id='latitude'/>
			</div>
		</div>
		<div id='controls3' class='container'>
			<button id='submit' class='btn btn-large btn-primary'>Get Data</button>
		</div>
		
		<div class='row' id='results'>
			<div id='resultsTableHolder' class='col-xs-12'>
				<table id='resultsTable'>
					<tr><th>Cell ID</th><th>Latitude</th><th>Longitude</th><th>Data Source</th><th>Variable</th><th>Value</th></th></tr>
					
				</table>
			</div>
		</div>
		<div class='row'>
		<button id='showMap'>Show Spatial Coordinates</button>
		<div class='col-xs-6' id='map'>
				
			</div>
		</div>
		<div id='log'>
			<h4>Application Log</h4>
		</div>
		
	</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script>
	console.log("In-file javascript is working.")
	
	$(document).ready(function(){
		load1 = false;
		load2 = false;
		
		function checkLoaded(){
			if ((load1) && (load2)){
				$("#log").append("<p>All controls loaded successfully.</p>")
				$("#log").append("<p>Ready to query for points</p>")
				$("#loading").text("Done.")
			}
		}
		var start_time = new Date().getTime();
		//populate the drop down menus
		$.ajax({
			//this list the variable types in the database table.
			url: "getAllVariables",
			beforeSend: function(){
				$("#log").append("<p>Requesting variable types from server.")
			},
			success: function(result){
				console.log("Got variable types from server.")
				result = JSON.parse(result)
				dataTypes = result['data']; //this is a list of variables
				i = 0
				while (i < dataTypes.length){
					item = dataTypes[i]
					str = "<option id='var" + i + "'>" + item + "</option>"
					$("#varSelect").append(str)
					i +=1
				}
				$("#log").append("<p>Got " + dataTypes.length + " variable types.")
				//elapsed time in ms
				var request_time = new Date().getTime() - start_time
				$("#log").append("<p>Variable request elapsed time " + request_time + " ms</p>" )
				load1 = true
				checkLoaded();
			},
			error: function(error){
				alert('Error!');
				console.log(error)
			},
			type: "POST"
		})

	$.ajax({
			//this list the data sources in the database table.
			url: "getAllSources",
			beforeSend: function(){
				$("#log").append("<p>Requesting data sources from server.")
			},
			success: function(result){
				console.log("Got data sources from server.")
				result = JSON.parse(result)
				sources = result['data']; //this is a list of variables
				i = 0
				while (i < sources.length){
					item = sources[i]
					str = "<option id='source" + i + "'>" + item + "</option>"
					$("#sourceSelect").append(str)
					i +=1
				}
				$("#log").append("<p>Got " + sources.length + " data sources.")
				//elapsed time in ms
				var request_time = new Date().getTime() - start_time
				$("#log").append("<p>Data source request elapsed time " + request_time + " ms</p>" );
				load2 = true;
				checkLoaded();
			},
			error: function(error){
				alert('Error!');
				console.log(error)
			},
			type: "POST"
		})
		
		//load the map interface
		var map = L.map('map').setView([37, -118], 5);
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);
		
		
		//get the data on submit button press
		$("#submit").click(function(){
			var start_time = new Date().getTime();
			$("#log").append("<p>Submit button clicked.</p>");
			//get input params
			var lat = $("#latitude").val();
			var lng = $("#longitude").val();
			var dataSource = $("#sourceSelect option:selected").text();
			var variable = $("#varSelect option:selected").text();
			var payload = {
				latitude: lat,
				longitude: lng,
				datasource: dataSource,
				variable: variable
			}
			console.log(payload)
			//do the ajax call to the server
			$.ajax({
				url: "getData", 
				data: payload,
				type: "GET",
				beforeSend: function(){
					$("#log").append("<p>Sending GET request for data.</p>")
				},
				success: function(result){
					$("#log").append("<p>Data request successful.</p>")
					//get elapsed time
					var request_time = new Date().getTime() - start_time
					$("#log").append("<p>Request time " + request_time + " ms</p>" )
					//put in the results
					result = JSON.parse(result)
					data = result['data'];
					console.log(data)
					//build the table string
					var item = data;
					var cellID = item['varID'];
					var variable = item['variable'];
					var dataSource = item['dataSource'];
					var value = item['value'];
					str = "<tr><td>" + cellID + "</td>"
					str += "<td>" + lat + "</td><td>" + lng + "</td>"
					str += "<td>" + dataSource + "</td>"
					str += "<td>" + variable + "</td>"
					str += "<td><b>" + value + "</td>"
					str += "</tr>" 
					//insert the string
					$("#resultsTable").append(str)
					//add a marker to the map
					var marker = L.marker([lat, lng]).addTo(map);
					i += 1
				},
				error: function(error){
					$("#log").append("<p>There was an error getting data.</p>")
					console.log("Error.")
				}
			});
			
		}); // end of submit function
		
		//show map on request
		$("#map").hide();
		$("#showMap").click(function(){
			$("#map").toggle();
		})
		
		
	
		});//end of document.ready function
</script>

</html>